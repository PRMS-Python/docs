
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>prms_python.optimizer &#8212; PRMS-Python v1.0.0</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../_static/prms-python-32x.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
<link href='https://fonts.googleapis.com/css?family=Ubuntu+Mono|Pacifico|Open+Sans|Metrophobic' rel='stylesheet' type='text/css'>

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for prms_python.optimizer</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">optimizer.py -- holds ``Optimizer`` and ``OptimizationResult`` classes for </span>
<span class="sd">optimization routines and management conducted on PRMS parameters.</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">log10</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">.data</span> <span class="k">import</span> <span class="n">Data</span>
<span class="kn">from</span> <span class="nn">.parameters</span> <span class="k">import</span> <span class="n">Parameters</span>
<span class="kn">from</span> <span class="nn">.simulation</span> <span class="k">import</span> <span class="n">Simulation</span><span class="p">,</span> <span class="n">SimulationSeries</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="k">import</span> <span class="n">load_statvar</span><span class="p">,</span> <span class="n">nash_sutcliffe</span><span class="p">,</span> <span class="n">percent_bias</span><span class="p">,</span> <span class="n">rmse</span>

<span class="n">OPJ</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span>


<div class="viewcode-block" id="Optimizer"><a class="viewcode-back" href="../../api.html#prms_python.Optimizer">[docs]</a><span class="k">class</span> <span class="nc">Optimizer</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Container for PRMS parameter optimization routines that are </span>
<span class="sd">    defined as stages similar to what is described in Hay, et al, 2006</span>
<span class="sd">    (ftp://brrftp.cr.usgs.gov/pub/mows/software/luca_s/jawraHay.pdf).</span>
<span class="sd">    Currently the ``monte_carlo`` method provides random parameter </span>
<span class="sd">    resampling routines using uniform and normal random variables. </span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from prms_python import Data, Optimizer, Parameters</span>
<span class="sd">        &gt;&gt;&gt; params = Parameters(&#39;path/to/parameters&#39;)</span>
<span class="sd">        &gt;&gt;&gt; data = Data(&#39;path/to/data&#39;)</span>
<span class="sd">        &gt;&gt;&gt; control = &#39;path/to/control&#39;</span>
<span class="sd">        &gt;&gt;&gt; work_directory = &#39;path/to/create/simulations&#39;</span>
<span class="sd">        &gt;&gt;&gt; optr = Optimizer(</span>
<span class="sd">                             params, </span>
<span class="sd">                             data, </span>
<span class="sd">                             control, </span>
<span class="sd">                             work_directory, </span>
<span class="sd">                             title=&#39;the title&#39;, </span>
<span class="sd">                             description=&#39;desc&#39;)</span>
<span class="sd">        &gt;&gt;&gt; measured = &#39;path/to/measured/csv&#39; </span>
<span class="sd">        &gt;&gt;&gt; statvar_name = &#39;basin_cfs&#39; # or any other valid statvar </span>
<span class="sd">        &gt;&gt;&gt; params_to_resample = [&#39;dday_intcp&#39;, &#39;dday_slope&#39;] # list of params</span>
<span class="sd">        &gt;&gt;&gt; optr.monte_carlo(measured, params_to_resample, statvar_name)</span>

<span class="sd">    &#39;&#39;&#39;</span>
        
    <span class="c1">#dic for min/max of parameter allowable ranges, add more when needed</span>
    <span class="n">param_ranges</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dday_intcp&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">60.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span> 
                    <span class="s1">&#39;dday_slope&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span>
                    <span class="s1">&#39;jh_coef&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">),</span> 
                    <span class="s1">&#39;pt_alpha&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span> 
                    <span class="s1">&#39;potet_coef_hru_mo&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span> 
                    <span class="s1">&#39;tmax_index&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">110.0</span><span class="p">),</span> 
                    <span class="s1">&#39;tmin_lapse&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span> 
                    <span class="s1">&#39;soil_moist_max&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span> 
                    <span class="s1">&#39;rain_adj&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span>
                    <span class="s1">&#39;ppt_rad_adj&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
                    <span class="s1">&#39;radadj_intcp&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                    <span class="s1">&#39;radadj_slope&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                    <span class="s1">&#39;radj_sppt&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                    <span class="s1">&#39;radj_wppt&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                    <span class="s1">&#39;radmax&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                   <span class="p">}</span> 

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">control_file</span><span class="p">,</span> <span class="n">working_dir</span><span class="p">,</span>
                 <span class="n">title</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">Parameters</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;parameters must be instance of Parameters&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Data</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;data must be instance of Data&#39;</span><span class="p">)</span>

        <span class="n">input_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">control_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">OPJ</span><span class="p">(</span><span class="n">input_dir</span><span class="p">,</span> <span class="s1">&#39;statvar.dat&#39;</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;You have no statvar.dat file in your model directory&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running PRMS on original data in </span><span class="si">{}</span><span class="s1"> for later comparison&#39;</span>\
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">input_dir</span><span class="p">))</span>
            <span class="n">sim</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">input_dir</span><span class="p">)</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">working_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">working_dir</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span> <span class="o">=</span> <span class="n">input_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_file</span> <span class="o">=</span> <span class="n">control_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">=</span> <span class="n">working_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measured_arb</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># for arbitrary output methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statvar_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arb_outputs</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="Optimizer.monte_carlo"><a class="viewcode-back" href="../../api.html#prms_python.Optimizer.monte_carlo">[docs]</a>    <span class="k">def</span> <span class="nf">monte_carlo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference_path</span><span class="p">,</span> <span class="n">param_names</span><span class="p">,</span> <span class="n">statvar_name</span><span class="p">,</span> \
                    <span class="n">stage</span><span class="p">,</span> <span class="n">n_sims</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;uniform&#39;</span><span class="p">,</span> <span class="n">mu_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>\
                    <span class="n">noise_factor</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        The ``monte_carlo`` method of ``Optimizer`` performs parameter</span>
<span class="sd">	random resampling techniques to a set of PRMS parameters and </span>
<span class="sd">        executes and manages the corresponding simulations.  </span>

<span class="sd">        Args:</span>
<span class="sd">            reference_path (str): path to measured data for optimization</span>
<span class="sd">            param_names (list): list of parameter names to resample</span>
<span class="sd">            statvar_name (str): name of statisical variable output name for</span>
<span class="sd">                optimization </span>
<span class="sd">            stage (str): custom name of optimization stage e.g. &#39;ddsolrad&#39; </span>
<span class="sd">        Kwargs:</span>
<span class="sd">            n_sims (int): number of simulations to conduct </span>
<span class="sd">                parameter optimization/uncertaitnty analysis.</span>
<span class="sd">            method (str): resampling method for parameters (normal or uniform)</span>
<span class="sd">            mu_factor (float): coefficient to scale mean of the parameter(s)</span>
<span class="sd">                to resample from when using the normal distribution to resample</span>
<span class="sd">                i.e. a value of 1.5 will sample from a normal rv with mean</span>
<span class="sd">                50% higher than the original parameter mean</span>
<span class="sd">            noise_factor (float): scales the variance of noise to add to</span>
<span class="sd">                parameter values when using normal rv (method=&#39;normal&#39;)</span>
<span class="sd">            nproc (int): number of processors available to run PRMS simulations</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">stage</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;stage name cannot contain an underscore&#39;</span><span class="p">)</span>
        <span class="c1"># assign the optimization object a copy of measured data for plots </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measured_arb</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">from_csv</span><span class="p">(</span><span class="n">reference_path</span><span class="p">,</span>\
                                               <span class="n">parse_dates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># statistical variable output name  </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statvar_name</span> <span class="o">=</span> <span class="n">statvar_name</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

        <span class="c1"># resample params for all simulations- potential place to serialize</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">:</span> <span class="c1"># create list of lists of resampled params</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sims</span><span class="p">):</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resample_param</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>\
                           <span class="n">mu_factor</span><span class="o">=</span><span class="n">mu_factor</span><span class="p">,</span> <span class="n">noise_factor</span><span class="o">=</span><span class="n">noise_factor</span><span class="p">))</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
        
        <span class="c1"># SimulationSeries comprised of each resampled param set</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">SimulationSeries</span><span class="p">(</span>
            <span class="n">Simulation</span><span class="o">.</span><span class="n">from_data</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">_mod_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span>\
                                   <span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">))],</span>\
                                   <span class="n">param_names</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">control_file</span><span class="p">,</span>
                <span class="n">OPJ</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span> <span class="c1"># name of sim: first param and mean value</span>
                    <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1:.10f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param_names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sims</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">nproc</span><span class="p">:</span>
            <span class="n">nproc</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">//</span> <span class="mi">2</span>
        
        <span class="c1"># run </span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">)</span><span class="o">.</span><span class="n">outputs_iter</span><span class="p">())</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">arb_outputs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span> <span class="c1"># for current instance- add outputs </span>

        <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        
        <span class="c1"># json metadata for Monte Carlo run </span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;params_adjusted&#39;</span> <span class="p">:</span> <span class="n">param_names</span><span class="p">,</span>
                 <span class="s1">&#39;statvar_name&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">statvar_name</span><span class="p">,</span>
                 <span class="s1">&#39;optimization_title&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
                 <span class="s1">&#39;optimization_description&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                 <span class="s1">&#39;start_datetime&#39;</span> <span class="p">:</span> <span class="n">start_time</span><span class="p">,</span>
                 <span class="s1">&#39;end_datetime&#39;</span> <span class="p">:</span> <span class="n">end_time</span><span class="p">,</span>
                 <span class="s1">&#39;measured&#39;</span> <span class="p">:</span> <span class="n">reference_path</span><span class="p">,</span>
                 <span class="s1">&#39;method&#39;</span> <span class="p">:</span> <span class="s1">&#39;Monte Carlo&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;mu_factor&#39;</span> <span class="p">:</span> <span class="n">mu_factor</span><span class="p">,</span>
                 <span class="s1">&#39;noise_factor&#39;</span> <span class="p">:</span> <span class="n">noise_factor</span><span class="p">,</span>
                 <span class="s1">&#39;resample&#39;</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span>
                 <span class="s1">&#39;sim_dirs&#39;</span> <span class="p">:</span> <span class="p">[],</span>
                 <span class="s1">&#39;stage&#39;</span><span class="p">:</span> <span class="n">stage</span><span class="p">,</span>
                 <span class="s1">&#39;original_params&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">base_file</span><span class="p">,</span>
                 <span class="s1">&#39;nproc&#39;</span><span class="p">:</span> <span class="n">nproc</span><span class="p">,</span>
                 <span class="s1">&#39;n_sims&#39;</span> <span class="p">:</span> <span class="n">n_sims</span>
               <span class="p">}</span>

        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;sim_dirs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;simulation_dir&#39;</span><span class="p">])</span>
       
        <span class="n">json_outfile</span> <span class="o">=</span> <span class="n">OPJ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">_create_metafile_name</span><span class="p">(</span>\
                          <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">stage</span><span class="p">))</span>
      
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_outfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outf</span><span class="p">:</span>  
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">outf</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>\
                      <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">Output information sent to </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span>\
                                               <span class="nb">format</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">,</span> <span class="n">json_outfile</span><span class="p">))</span></div>

<div class="viewcode-block" id="Optimizer.plot_optimization"><a class="viewcode-back" href="../../api.html#prms_python.Optimizer.plot_optimization">[docs]</a>    <span class="k">def</span> <span class="nf">plot_optimization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;time_series&#39;</span><span class="p">,</span>\
                          <span class="n">plot_vars</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">plot_1to1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_fig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>\
                          <span class="n">n_plots</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Basic plotting of current optimization results with limited options. </span>
<span class="sd">        Plots measured, original simluated, and optimization simulated variabes</span>
<span class="sd">        Not recommended for plotting results when n_sims is very large, instead </span>
<span class="sd">        use options from an OptimizationResult object, or employ a user-defined </span>
<span class="sd">        method using the result data.</span>

<span class="sd">        Kwargs:</span>
<span class="sd">            freq (str): frequency of time series plots, value can be &#39;daily&#39;</span>
<span class="sd">                or &#39;monthly&#39; for solar radiation </span>
<span class="sd">            method (str): &#39;time_series&#39; for time series sub plot of each</span>
<span class="sd">                simulation alongside measured radiation. Another choice is </span>
<span class="sd">                &#39;correlation&#39; which plots each measured daily solar radiation</span>
<span class="sd">                value versus the corresponding simulated variable as subplots</span>
<span class="sd">                one for each simulation in the optimization. With coefficients</span>
<span class="sd">                of determiniationi i.e. square of pearson correlation coef.  </span>
<span class="sd">            plot_vars (str): what to plot alongside simulated srad: </span>
<span class="sd">                &#39;meas&#39;: plot simulated along with measured swrad</span>
<span class="sd">                &#39;orig&#39;: plot simulated along with the original simulated swrad</span>
<span class="sd">                &#39;both&#39;: plot simulated, with original simulation and measured</span>
<span class="sd">            plot_1to1 (bool): if True plot one to one line on correlation </span>
<span class="sd">                scatter plot, otherwise exclude.</span>
<span class="sd">            return_fig (bool): flag whether to return matplotlib figure </span>
<span class="sd">        Returns: </span>
<span class="sd">            f (matplotlib.figure.Figure): If kwarg return_fig=True, then return</span>
<span class="sd">                copy of the figure that is generated to the user. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">arb_outputs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You have not run any optimizations&#39;</span><span class="p">)</span>
        <span class="n">var_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statvar_name</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measured_arb</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">load_statvar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arb_outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>\
                           <span class="p">[</span><span class="s1">&#39;statvar&#39;</span><span class="p">])[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_name</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">orig</span> <span class="o">=</span> <span class="n">load_statvar</span><span class="p">(</span><span class="n">OPJ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span><span class="p">,</span> <span class="s1">&#39;statvar.dat&#39;</span><span class="p">))[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span>\
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_name</span><span class="p">)][</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">meas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measured_arb</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">sims</span> <span class="o">=</span> <span class="p">[</span><span class="n">load_statvar</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;statvar&#39;</span><span class="p">])[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_name</span><span class="p">)][</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> \
                <span class="n">out</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arb_outputs</span><span class="p">]</span>
        <span class="n">simdirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;simulation_dir&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span>\
                   <span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arb_outputs</span><span class="p">]</span>
        <span class="n">var_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statvar_name</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arb_outputs</span><span class="p">)</span> <span class="c1"># number of simulations to plot</span>
        <span class="c1"># user defined number of subplots from first n_plots results </span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">n_plots</span><span class="p">):</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n_plots</span>  
        <span class="c1"># styles for each plot</span>
        <span class="n">ms</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1"># markersize for all points</span>
        <span class="n">orig_sty</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="n">ms</span><span class="p">,</span>\
                           <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span>\
                           <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;royalblue&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;royalblue&#39;</span><span class="p">)</span> 
        <span class="n">meas_sty</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="n">ms</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>\
                           <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>\
                           <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span> 
        <span class="n">sim_sty</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="n">ms</span><span class="p">,</span>\
                           <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>\
                           <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> 
        <span class="c1">## number of subplots and rows (two plots per row) </span>
        <span class="n">nrow</span> <span class="o">=</span> <span class="n">n</span><span class="o">//</span><span class="mi">2</span> <span class="c1"># round down if odd n</span>
        <span class="n">ncol</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">odd_n</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">/</span><span class="mf">2.</span> <span class="o">-</span> <span class="n">nrow</span> <span class="o">==</span> <span class="mf">0.5</span><span class="p">:</span> 
            <span class="n">nrow</span><span class="o">+=</span><span class="mi">1</span> <span class="c1"># odd number need extra row</span>
            <span class="n">odd_n</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1">########</span>
        <span class="c1">## Start plots depnding on key word arguments</span>
        <span class="c1">########</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;daily&#39;</span> <span class="ow">and</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;time_series&#39;</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>\
                                   <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="n">n</span><span class="o">*</span><span class="mf">3.5</span><span class="p">))</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">sim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sims</span><span class="p">[:</span><span class="n">n</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">plot_vars</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;meas&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">):</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">meas</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Measured&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">meas_sty</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">plot_vars</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;orig&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">):</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original sim.&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">orig_sty</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="o">**</span><span class="n">sim_sty</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;sim: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">simdirs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">markerscale</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">autofmt_xdate</span><span class="p">()</span>
        <span class="c1">#monthly means</span>
        <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;monthly&#39;</span> <span class="ow">and</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;time_series&#39;</span><span class="p">:</span>
            <span class="c1"># compute monthly means</span>
            <span class="n">meas</span> <span class="o">=</span> <span class="n">meas</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">meas</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">orig</span> <span class="o">=</span> <span class="n">orig</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">orig</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="c1"># change line styles for monthly plots to lines not points</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">(</span><span class="n">orig_sty</span><span class="p">,</span> <span class="n">meas_sty</span><span class="p">,</span> <span class="n">sim_sty</span><span class="p">):</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;linestyle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;marker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncol</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="n">n</span><span class="o">*</span><span class="mf">3.5</span><span class="p">))</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">sim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sims</span><span class="p">[:</span><span class="n">n</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">plot_vars</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;meas&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">):</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">meas</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Measured&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">meas_sty</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">plot_vars</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;orig&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">):</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original sim.&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">orig_sty</span><span class="p">)</span>
                <span class="n">sim</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="o">**</span><span class="n">sim_sty</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;sim: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">mean&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">simdirs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>\
                                  <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">12.5</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">markerscale</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">odd_n</span><span class="p">:</span> <span class="c1"># empty subplot if odd number of simulations </span>
                <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">)</span> 
        <span class="c1">#x-y scatter</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;correlation&#39;</span><span class="p">:</span>
            <span class="c1">## figure</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncol</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="n">n</span><span class="o">*</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="c1">## subplot dimensions</span>
            <span class="n">meas_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> 
            <span class="n">meas_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sims</span><span class="p">[:</span><span class="n">n</span><span class="p">]):</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">sim</span>
                <span class="n">sim_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
                <span class="n">sim_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
                <span class="n">m</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">meas_max</span><span class="p">,</span><span class="n">sim_max</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">plot_1to1</span><span class="p">:</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1">## one to one line</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">meas_min</span><span class="p">,</span><span class="n">meas_max</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">sim_min</span><span class="p">,</span> <span class="n">sim_max</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="o">**</span><span class="n">sim_sty</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;sim: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">simdirs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Measured </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_name</span><span class="p">))</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;$R^2 = </span><span class="si">{0:.2f}</span><span class="s1">$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>\
                            <span class="n">X</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>\
                            <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>  
            <span class="k">if</span> <span class="n">odd_n</span><span class="p">:</span> <span class="c1"># empty subplot if odd number of simulations </span>
                <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>      

        <span class="k">if</span> <span class="n">return_fig</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fig</span></div></div>

<span class="k">def</span> <span class="nf">_create_metafile_name</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">opt_title</span><span class="p">,</span> <span class="n">stage</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Search through output directory where simulations are conducted</span>
<span class="sd">    look for all metadata simulation json files and find out if the</span>
<span class="sd">    current simulation is a replicate. Then use that information to </span>
<span class="sd">    build the correct file name for the output json file. The series</span>
<span class="sd">    are typically run in parallel that is why this step has to be </span>
<span class="sd">    done after running multiple simulations from an optimization stage.</span>

<span class="sd">    Args:</span>
<span class="sd">        out_dir (str): path to directory with model results, i.e. </span>
<span class="sd">            location where simulation series outputs and optimization</span>
<span class="sd">            json files are located, aka Optimizer.working_dir</span>
<span class="sd">        opt_title (str): optimization instance title for file search</span>
<span class="sd">    stage (str): stage of optimization, e.g. &#39;swrad&#39;, &#39;pet&#39; </span>

<span class="sd">    Returns:</span>
<span class="sd">    name (str): file name for the current optimization simulation series</span>
<span class="sd">        metadata json file. E.g &#39;dry_creek_swrad_opt.json&#39;, or if</span>
<span class="sd">        this is the second time you have run an optimization titled</span>
<span class="sd">        &#39;dry_creek&#39; the next json file will be returned as </span>
<span class="sd">        &#39;dry_creek_swrad_opt1.json&#39; and so on with integer increments     </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">meta_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_opt(\d*)\.json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opt_title</span><span class="p">,</span> <span class="n">stage</span><span class="p">))</span>
    <span class="n">reps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span> 
        <span class="k">if</span> <span class="n">meta_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">nrep</span> <span class="o">=</span> <span class="n">meta_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nrep</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> 
                <span class="n">reps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nrep</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">reps</span><span class="p">:</span> 
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_opt.json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opt_title</span><span class="p">,</span> <span class="n">stage</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># this is the nth optimization done under the same title</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">reps</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_opt</span><span class="si">{}</span><span class="s1">.json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opt_title</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">name</span>

<span class="k">def</span> <span class="nf">resample_param</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;uniform&#39;</span><span class="p">,</span> <span class="n">mu_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>\
                   <span class="n">noise_factor</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resample PRMS parameter by shifting all values by a constant that is </span>
<span class="sd">    taken from a uniform distribution, where the range of the uniform </span>
<span class="sd">    values is equal to the difference between the min and max of the allowable </span>
<span class="sd">    range from PRMS. The parameter min and max are set in Optimizer.param_ranges </span>
<span class="sd">    If the resampling method (``how`` argument) is set to &#39;normal&#39;, randomly </span>
<span class="sd">    sample a normal distribution with mean = mean(parameter) X ``mu_factor`` and </span>
<span class="sd">    sigma = param allowable range multiplied by ``noise_factor``. If parameters have</span>
<span class="sd">    array length &lt;= 366 then individual parameter values are resampled otherwise</span>
<span class="sd">    resample all param values at once, e.g. by taking a single random value </span>
<span class="sd">    from the uniform distribution. If they are taking all at once using the </span>
<span class="sd">    normal method then the original values are scaled by mu_factor and a normal </span>
<span class="sd">    random variable with mean=0 and std dev = parameter range X ``noise_factor``. </span>

<span class="sd">    Args:</span>
<span class="sd">        params (parameters.Parameters): ``Parameters`` object </span>
<span class="sd">        param_name (str): name of PRMS parameter to resample</span>
<span class="sd">    Kwargs: </span>
<span class="sd">        how (str): distribution to resample parameters from in the case </span>
<span class="sd">            that each parameter element can be resampled (len &lt;=366)</span>
<span class="sd">            Currently works for uniform and normal distributions. </span>
<span class="sd">        noise_factor (float): factor to multiply parameter range by, </span>
<span class="sd">            use the result as the standard deviation for the normal rand.</span>
<span class="sd">            variable used to add element wise noise. i.e. higher </span>
<span class="sd">            noise_factor will result in higher variance. Must be &gt; 0.</span>
<span class="sd">    Returns:</span>
<span class="sd">        ret (numpy.ndarry): ndarray of param after resampling </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p_min</span><span class="p">,</span> <span class="n">p_max</span> <span class="o">=</span> <span class="n">Optimizer</span><span class="o">.</span><span class="n">param_ranges</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param_name</span><span class="p">,(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    
    <span class="c1"># create dictionary of parameter basic info (not values)</span>
    <span class="n">param_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span> <span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">base_params</span><span class="p">}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">param_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param_name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is not a valid parameter&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param_name</span><span class="p">))</span>
        
    <span class="k">if</span> <span class="n">p_min</span> <span class="o">==</span> <span class="n">p_max</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="si">{}</span><span class="s2"> has not been added to the dictionary of</span>
<span class="s2">        parameters to resample, add it&#39;s allowable min and max value</span>
<span class="s2">        to the Optimizer.param_ranges attribute in</span>
<span class="s2">        Optimizer.py&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param_name</span><span class="p">))</span>
        
    <span class="n">dim_case</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nhru</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="s1">&#39;nhru&#39;</span><span class="p">]</span>
    <span class="n">ndims</span> <span class="o">=</span> <span class="n">param_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param_name</span><span class="p">)[</span><span class="s1">&#39;ndims&#39;</span><span class="p">]</span>
    <span class="n">dimnames</span> <span class="o">=</span> <span class="n">param_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param_name</span><span class="p">)[</span><span class="s1">&#39;dimnames&#39;</span><span class="p">]</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">param_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param_name</span><span class="p">)[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">param_name</span><span class="p">])</span>
    
    <span class="c1"># could expand list and check parameter name also e.g. cascade_flg</span>
    <span class="c1"># is a parameter that should not be changed </span>
    <span class="n">dims_to_not_change</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;ncascade&#39;</span><span class="p">,</span><span class="s1">&#39;ncascdgw&#39;</span><span class="p">,</span><span class="s1">&#39;nreach&#39;</span><span class="p">,</span>\
                             <span class="s1">&#39;nsegment&#39;</span><span class="p">])</span> 
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">dims_to_not_change</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">dimnames</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="si">{}</span><span class="s2"> should not be resampled as</span>
<span class="s2">                          it relates to the location of cascade flow</span>
<span class="s2">                          parameters.&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param_name</span><span class="p">))</span>
        
    <span class="c1"># use param info to get dimension info- e.g. if multidimensional</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ndims</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">366</span><span class="p">):</span>
        <span class="n">dim_case</span> <span class="o">=</span> <span class="s1">&#39;resample_each_value&#39;</span> <span class="c1"># for smaller param dimensions</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">ndims</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">366</span><span class="p">):</span>
        <span class="n">dim_case</span> <span class="o">=</span> <span class="s1">&#39;resample_all_values_once&#39;</span> <span class="c1"># covers nssr, ngw, etc. </span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">ndims</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">dimnames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;nmonths&#39;</span> <span class="ow">and</span> \
          <span class="n">nhru</span> <span class="o">==</span> <span class="n">params</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="n">dimnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]]):</span>
        <span class="n">dim_case</span> <span class="o">=</span> <span class="s1">&#39;nhru_nmonths&#39;</span>   
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">dim_case</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The </span><span class="si">{}</span><span class="s1"> parameter is not set for resampling&#39;</span><span class="o">.</span>\
                         <span class="nb">format</span><span class="p">(</span><span class="n">param_name</span><span class="p">))</span>        
<span class="c1">#     #testing purposes    </span>
<span class="c1">#     print(&#39;name: &#39;, param_name)</span>
<span class="c1">#     print(&#39;max_val: &#39;, p_max)</span>
<span class="c1">#     print(&#39;min_val: &#39;, p_min)</span>
<span class="c1">#     print(&#39;ndims: &#39;, ndims)</span>
<span class="c1">#     print(&#39;dimnames: &#39;, dimnames)</span>
<span class="c1">#     print(&#39;length: &#39;, length)</span>
<span class="c1">#     print(&#39;resample_method: &#39;, dim_case)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_max</span> <span class="o">-</span> <span class="n">p_min</span><span class="p">)</span> <span class="o">*</span> <span class="n">noise_factor</span> <span class="c1"># std_dev (s) default: param_range/10  </span>
    <span class="c1">#do resampling based on param dimensions and sampling distribution</span>
    <span class="k">if</span> <span class="n">dim_case</span> <span class="o">==</span> <span class="s1">&#39;resample_all_values_once&#39;</span><span class="p">:</span> 
        <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">p_min</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">p_max</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> 
        <span class="k">elif</span> <span class="n">how</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">:</span> <span class="c1"># scale parameter mean if mu_factor given </span>
            <span class="n">param</span> <span class="o">*=</span> <span class="n">mu_factor</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="n">param</span>

    <span class="k">elif</span> <span class="n">dim_case</span> <span class="o">==</span> <span class="s1">&#39;resample_each_value&#39;</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">param</span>
        <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">p_min</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">p_max</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">how</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">:</span> <span class="c1"># the original value is considered the mean</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
                    <span class="n">mu</span> <span class="o">=</span> <span class="n">el</span> <span class="o">*</span> <span class="n">mu_factor</span>
                    <span class="n">ret</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span> <span class="c1"># single value parameter</span>
                <span class="n">mu</span> <span class="o">=</span> <span class="n">param</span> <span class="o">*</span> <span class="n">mu_factor</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

    <span class="c1"># nhru by nmonth dimensional params</span>
    <span class="k">elif</span> <span class="n">dim_case</span> <span class="o">==</span> <span class="s1">&#39;nhru_nmonths&#39;</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">param</span>
        <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
                <span class="n">ret</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">p_min</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">p_max</span><span class="p">,</span>\
                                                           <span class="n">size</span><span class="o">=</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">how</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
                <span class="n">el</span> <span class="o">*=</span> <span class="n">mu_factor</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">el</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">ret</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="n">el</span>

    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">_mod_params</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">param_names</span><span class="p">):</span>
    <span class="c1"># loop through list of params and assign their values to Parameter instance</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
        <span class="n">ret</span><span class="p">[</span><span class="n">param_names</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>


<div class="viewcode-block" id="OptimizationResult"><a class="viewcode-back" href="../../api.html#prms_python.OptimizationResult">[docs]</a><span class="k">class</span> <span class="nc">OptimizationResult</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The ``OptimizationResult`` object serves to collect and manage output </span>
<span class="sd">    from an ``Optimizer`` method. Upon initialization and a given optimization</span>
<span class="sd">    stage that was used when running the Optimizer method, e.g. ``monte_carlo``,</span>
<span class="sd">    the class gathers all JSON metadata that was produced for the given stage. </span>
<span class="sd">    The ``OptimizationResult`` has three main user methods: first ``result_table`` </span>
<span class="sd">    which returns the top n simulations according to four model performance </span>
<span class="sd">    metrics (Nash-Sutcliffe efficiency (NSE), root-mean squared-error (RMSE), </span>
<span class="sd">    percent bias (PBIAS), and the coefficient of determination (COEF_DET) as</span>
<span class="sd">    calculated against measured data. For example the table may look like:</span>
<span class="sd">     </span>
<span class="sd">        &gt;&gt;&gt; ddsolrad_res = OptimizationResult(work_directory, stage=stage)</span>
<span class="sd">        &gt;&gt;&gt; top10 = ddsolrad_res.result_table(freq=&#39;monthly&#39;,top_n=10)</span>
<span class="sd">        &gt;&gt;&gt; top10</span>
<span class="sd">            ========================  ========  =======  =========   ========</span>
<span class="sd">            ddsolrad parameters	      NSE	RMSE  	 PBIAS	     COEF_DET</span>
<span class="sd">            ========================  ========  =======  =========   ======== </span>
<span class="sd">	    orig_params	              0.956267	39.4725	 -0.885715   0.963116</span>
<span class="sd">	    tmax_index_54.2224631748  0.921626	47.6092	 -0.849256   0.94402</span>
<span class="sd">	    tmax_index_44.8823940703  0.879965	58.9194	 5.79603     0.922021</span>
<span class="sd">	    tmax_index_47.6835387480  0.764133	82.5918	 -4.78896    0.837582</span>
<span class="sd">            ========================  ========  =======  =========   ========</span>

<span class="sd">    Second, the ``get_top_ranked_sims`` which returns a dictionary that map </span>
<span class="sd">    key information about the top n ranked simulations, an example returned </span>
<span class="sd">    dictionary may look like:</span>

<span class="sd">       &gt;&gt;&gt; {</span>
<span class="sd">             &#39;dir_name&#39; : [&#39;pathToSim1&#39;, &#39;pathToSim2&#39;],</span>
<span class="sd">             &#39;param_path&#39; : [&#39;pathToSim1/input/parameters&#39;, &#39;pathToSim2/input/parameters&#39;],</span>
<span class="sd">             &#39;statvar_path&#39; : [&#39;pathToSim1/output/statvar.dat&#39;, &#39;pathToSim2/output/statvar.dat&#39;],</span>
<span class="sd">             &#39;params_adjusted&#39; : [[param_names_sim1], [param_names_sim2]]</span>
<span class="sd">           }</span>

<span class="sd">    The third method of ``OptimizationResult`` is ``archive`` which essentially </span>
<span class="sd">    opens all parameter and statvar files from each simulation of the given </span>
<span class="sd">    stage and archives the parameters that were modified and their modified values</span>
<span class="sd">    and the statistical variable (PRMS time series output) that is associated with </span>
<span class="sd">    the optimization stage.  Other ``Optimizer`` simulation metadata is also gathered</span>
<span class="sd">    and new JSON metadata containing only this information is created and written</span>
<span class="sd">    within a newly created &quot;archived&quot; subdirectory within the same directory that </span>
<span class="sd">    the ``Optimizer`` routine managed simulations. The ``OptimizationResult.archive``</span>
<span class="sd">    method then recursively deletes the simulation data for each of the given stage. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">working_dir</span><span class="p">,</span> <span class="n">stage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an ``OptimizationResult`` instance to manage output and analyse parameter-</span>
<span class="sd">        output relationships as produced by the use of an ``Optimizer`` method of a user</span>
<span class="sd">        defined optimization stage.      </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">=</span> <span class="n">working_dir</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">stage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_json_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_optr_jsons</span><span class="p">(</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">stage</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">total_sims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_total_sims</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statvar_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_statvar_name</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measured</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_measured</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_input_dir</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_input_params</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>

        <span class="c1"># if there are more than one input param for given stage</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
<span class="sd">&quot;&quot;&quot;Warning: there were more than one initial parameter sets used for the </span>
<span class="sd">    optimization for stage: {}. Make sure to compare the the correct input </span>
<span class="sd">    params with their corresponding output sims.&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stage</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">This optimization stage used the</span><span class="se">\</span>
<span class="s1"> following input parameter files:</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_params</span><span class="p">)))</span>
 
    <span class="k">def</span> <span class="nf">_count_total_sims</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># total number of simulations of given stage in working directory</span>
        <span class="n">tracked_dirs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_json_paths</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="p">]:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
                <span class="n">tracked_dirs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">json_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sim_dirs&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracked_dirs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_optr_jsons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">,</span> <span class="n">stage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve locations of optimization output jsons which contain </span>
<span class="sd">        metadata needed to understand optimization results.</span>
<span class="sd">        Create dictionary of each optimization with stage as key and lists</span>
<span class="sd">        of corresponding json file paths as values. </span>

<span class="sd">        Args:</span>
<span class="sd">            work_dir (str): path to directory with model results, i.e. </span>
<span class="sd">                location where simulation series outputs and optimization</span>
<span class="sd">                json files are located, aka Optimizer.working_dir</span>
<span class="sd">            stage (str): the stage (&#39;ddsolrad&#39;, &#39;jhpet&#39;, &#39;flow&#39;, etc.) of </span>
<span class="sd">                the optimization in which to gather the jsons</span>
<span class="sd">        Returns:</span>
<span class="sd">            ret (dict): dictionary of stage (keys) and lists of </span>
<span class="sd">                json file paths for that stage (values).  </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">optr_metafile_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^.*_</span><span class="si">{}</span><span class="s1">_opt(\d*)\.json&#39;</span><span class="o">.</span>\
                                      <span class="nb">format</span><span class="p">(</span><span class="n">stage</span><span class="p">))</span>
        <span class="n">ret</span><span class="p">[</span><span class="n">stage</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">OPJ</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span>\
                          <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span> <span class="k">if</span>\
                          <span class="n">optr_metafile_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_get_input_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">):</span>
        <span class="c1"># retrieves the input directory from the first json file of given stage</span>
        <span class="n">json_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_json_paths</span><span class="p">[</span><span class="n">stage</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">jf</span><span class="p">:</span>
            <span class="n">meta_dic</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">jf</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta_dic</span><span class="p">[</span><span class="s1">&#39;original_params&#39;</span><span class="p">]</span><span class="o">.</span>\
                                                            <span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> 

    <span class="k">def</span> <span class="nf">_get_input_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">):</span>
        <span class="n">json_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_json_paths</span><span class="p">[</span><span class="n">stage</span><span class="p">]</span>
        <span class="n">param_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">json_file</span> <span class="ow">in</span> <span class="n">json_files</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">jf</span><span class="p">:</span>
                <span class="n">meta_dic</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">jf</span><span class="p">)</span>
                <span class="n">param_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meta_dic</span><span class="p">[</span><span class="s1">&#39;original_params&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">param_paths</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_sim_dirs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">):</span>
        <span class="n">jsons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_json_paths</span><span class="p">[</span><span class="n">stage</span><span class="p">]</span>
        <span class="n">json_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sim_dirs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">inf</span> <span class="ow">in</span> <span class="n">jsons</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">inf</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="n">json_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">json_file</span> <span class="ow">in</span> <span class="n">json_files</span><span class="p">:</span>
            <span class="n">sim_dirs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">json_file</span><span class="p">[</span><span class="s1">&#39;sim_dirs&#39;</span><span class="p">])</span>
        <span class="c1"># list of all simulation directory paths for stage </span>
        <span class="k">return</span> <span class="n">sim_dirs</span>

    <span class="k">def</span> <span class="nf">_get_measured</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">):</span>
        <span class="c1"># only need to open one json file to get this information</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_json_paths</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stage</span><span class="p">):</span>
            <span class="k">return</span> <span class="c1"># no optimization json files exist for given stage</span>
        <span class="n">first_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_json_paths</span><span class="p">[</span><span class="n">stage</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">first_json</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
        <span class="n">measured_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">from_csv</span><span class="p">(</span><span class="n">json_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;measured&#39;</span><span class="p">),</span>\
                                              <span class="n">parse_dates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">measured_series</span> 

    <span class="k">def</span> <span class="nf">_get_statvar_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">):</span>
        <span class="c1"># only need to open one json file to get this information</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">first_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_json_paths</span><span class="p">[</span><span class="n">stage</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;No optimization has been run for</span>
<span class="s2">                              stage: </span><span class="si">{}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stage</span><span class="p">))</span>    
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">first_json</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
        <span class="n">var_name</span> <span class="o">=</span> <span class="n">json_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;statvar_name&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">var_name</span>

    <span class="k">def</span> <span class="nf">result_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1">##TODO: add stats for freq options annual (means or sum)</span>

        <span class="n">sim_dirs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sim_dirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">top_n</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sim_dirs</span><span class="p">):</span> 
            <span class="n">top_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sim_dirs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># for returning inclusive last sim</span>
        <span class="n">sim_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">sim_dirs</span><span class="p">]</span> 
        <span class="n">meas_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_measured</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="p">)</span>
        <span class="n">statvar_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_statvar_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="p">)</span>
        <span class="n">orig_statvar</span> <span class="o">=</span> <span class="n">load_statvar</span><span class="p">(</span><span class="n">OPJ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span><span class="p">,</span><span class="s1">&#39;statvar.dat&#39;</span><span class="p">))</span>\
                       <span class="p">[</span><span class="n">statvar_name</span><span class="p">]</span>

        <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span>\
                            <span class="p">[</span><span class="s1">&#39;NSE&#39;</span><span class="p">,</span><span class="s1">&#39;RMSE&#39;</span><span class="p">,</span><span class="s1">&#39;PBIAS&#39;</span><span class="p">,</span><span class="s1">&#39;COEF_DET&#39;</span><span class="p">,</span><span class="s1">&#39;ABS(PBIAS)&#39;</span><span class="p">])</span>
        <span class="n">orig_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;orig_params&#39;</span><span class="p">],</span>\
                                 <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NSE&#39;</span><span class="p">,</span><span class="s1">&#39;RMSE&#39;</span><span class="p">,</span><span class="s1">&#39;PBIAS&#39;</span><span class="p">,</span><span class="s1">&#39;COEF_DET&#39;</span><span class="p">])</span>
        <span class="c1"># get datetime indices that overlap from measured and simulated</span>
        <span class="n">sim_out</span> <span class="o">=</span> <span class="n">load_statvar</span><span class="p">(</span><span class="n">OPJ</span><span class="p">(</span><span class="n">sim_dirs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;outputs&#39;</span><span class="p">,</span> <span class="s1">&#39;statvar.dat&#39;</span><span class="p">))</span>\
                                               <span class="p">[</span><span class="n">statvar_name</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">meas_var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">sim_out</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">meas_var</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">meas_var</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="c1">#sim_out = sim_out[idx]    </span>
        <span class="n">orig_statvar</span> <span class="o">=</span> <span class="n">orig_statvar</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;monthly&#39;</span><span class="p">:</span>
            <span class="n">meas_mo</span> <span class="o">=</span> <span class="n">meas_var</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">meas_var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">orig_mo</span> <span class="o">=</span> <span class="n">orig_statvar</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">orig_statvar</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>            
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sim_dirs</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span> 
                <span class="n">sim_out</span> <span class="o">=</span> <span class="n">load_statvar</span><span class="p">(</span><span class="n">OPJ</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="s1">&#39;outputs&#39;</span><span class="p">,</span> <span class="s1">&#39;statvar.dat&#39;</span><span class="p">))</span>\
                                               <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">statvar_name</span><span class="p">)]</span>
            <span class="k">except</span><span class="p">:</span> <span class="c1"># simulation might have been removed or missing</span>
                <span class="k">pass</span>

            <span class="n">sim_out</span> <span class="o">=</span> <span class="n">sim_out</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>    
            <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;daily&#39;</span><span class="p">:</span>
                <span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sim_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>\
                              <span class="n">nash_sutcliffe</span><span class="p">(</span><span class="n">meas_var</span><span class="p">,</span> <span class="n">sim_out</span><span class="p">),</span>\
                              <span class="n">rmse</span><span class="p">(</span><span class="n">meas_var</span><span class="p">,</span> <span class="n">sim_out</span><span class="p">),</span>\
                              <span class="n">percent_bias</span><span class="p">(</span><span class="n">meas_var</span><span class="p">,</span><span class="n">sim_out</span><span class="p">),</span>\
                              <span class="n">meas_var</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">sim_out</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>\
                              <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">percent_bias</span><span class="p">(</span><span class="n">meas_var</span><span class="p">,</span> <span class="n">sim_out</span><span class="p">))</span> <span class="p">]</span>                                  
                <span class="n">orig_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;orig_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>\
                              <span class="n">nash_sutcliffe</span><span class="p">(</span><span class="n">orig_statvar</span><span class="p">,</span><span class="n">meas_var</span><span class="p">),</span>\
                              <span class="n">rmse</span><span class="p">(</span><span class="n">orig_statvar</span><span class="p">,</span><span class="n">meas_var</span><span class="p">),</span>\
                              <span class="n">percent_bias</span><span class="p">(</span><span class="n">orig_statvar</span><span class="p">,</span><span class="n">meas_var</span><span class="p">),</span>\
                              <span class="n">orig_statvar</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">meas_var</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span>
                              
            <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="s1">&#39;monthly&#39;</span><span class="p">:</span>
                <span class="n">sim_out</span> <span class="o">=</span> <span class="n">sim_out</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">sim_out</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sim_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>\
                              <span class="n">nash_sutcliffe</span><span class="p">(</span><span class="n">meas_mo</span><span class="p">,</span> <span class="n">sim_out</span><span class="p">),</span>\
                              <span class="n">rmse</span><span class="p">(</span><span class="n">meas_mo</span><span class="p">,</span> <span class="n">sim_out</span><span class="p">),</span>\
                              <span class="n">percent_bias</span><span class="p">(</span><span class="n">meas_mo</span><span class="p">,</span> <span class="n">sim_out</span><span class="p">),</span>\
                              <span class="n">meas_mo</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">sim_out</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>\
                              <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">percent_bias</span><span class="p">(</span><span class="n">meas_mo</span><span class="p">,</span> <span class="n">sim_out</span><span class="p">))</span> <span class="p">]</span>    
                <span class="n">orig_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;orig_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>\
                              <span class="n">nash_sutcliffe</span><span class="p">(</span><span class="n">orig_mo</span><span class="p">,</span><span class="n">meas_mo</span><span class="p">),</span>\
                              <span class="n">rmse</span><span class="p">(</span><span class="n">orig_mo</span><span class="p">,</span><span class="n">meas_mo</span><span class="p">),</span>\
                              <span class="n">percent_bias</span><span class="p">(</span><span class="n">orig_mo</span><span class="p">,</span><span class="n">meas_mo</span><span class="p">),</span>\
                              <span class="n">orig_mo</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">meas_mo</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span>
                                 
        <span class="n">sorted_result</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NSE&#39;</span><span class="p">,</span><span class="s1">&#39;RMSE&#39;</span><span class="p">,</span><span class="s1">&#39;ABS(PBIAS)&#39;</span><span class="p">,</span>\
                               <span class="s1">&#39;COEF_DET&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">])</span>
        <span class="n">sorted_result</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> parameters&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="p">)</span>
        <span class="n">sorted_result</span> <span class="o">=</span> <span class="n">sorted_result</span><span class="p">[[</span><span class="s1">&#39;NSE&#39;</span><span class="p">,</span><span class="s1">&#39;RMSE&#39;</span><span class="p">,</span><span class="s1">&#39;PBIAS&#39;</span><span class="p">,</span><span class="s1">&#39;COEF_DET&#39;</span><span class="p">]]</span> 
        <span class="n">sorted_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">orig_results</span><span class="p">,</span><span class="n">sorted_result</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">latex</span><span class="p">:</span> <span class="k">return</span> <span class="n">sorted_result</span><span class="p">[:</span><span class="n">top_n</span><span class="p">]</span><span class="o">.</span><span class="n">to_latex</span><span class="p">(</span><span class="n">escape</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span>  <span class="n">sorted_result</span><span class="p">[:</span><span class="n">top_n</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_top_ranked_sims</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sorted_df</span><span class="p">):</span>
        <span class="c1"># use result table to make dic with best param and statvar paths </span>
        <span class="c1"># index of table are simulation directory names</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span>
              <span class="s1">&#39;dir_name&#39;</span> <span class="p">:</span> <span class="p">[],</span>
              <span class="s1">&#39;param_path&#39;</span> <span class="p">:</span> <span class="p">[],</span>
              <span class="s1">&#39;statvar_path&#39;</span> <span class="p">:</span> <span class="p">[],</span>
              <span class="s1">&#39;params_adjusted&#39;</span> <span class="p">:</span> <span class="p">[]</span>
              <span class="p">}</span>
        
        <span class="n">json_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_json_paths</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="p">]</span>         
        
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">sorted_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;orig_params&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;dir_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
            <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;param_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OPJ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span><span class="n">el</span><span class="p">,</span><span class="s1">&#39;inputs&#39;</span><span class="p">,</span>\
                                                                 <span class="s1">&#39;parameters&#39;</span><span class="p">))</span>
            <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;statvar_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OPJ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span><span class="n">el</span><span class="p">,</span><span class="s1">&#39;outputs&#39;</span><span class="p">,</span>\
                                                                <span class="s1">&#39;statvar.dat&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">json_paths</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">OPJ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span> <span class="ow">in</span> <span class="n">json_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sim_dirs&#39;</span><span class="p">):</span>
                        <span class="n">ret</span><span class="p">[</span><span class="s1">&#39;params_adjusted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>\
                                             <span class="n">json_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;params_adjusted&#39;</span><span class="p">))</span>  
                  
        <span class="k">return</span> <span class="n">ret</span>

<div class="viewcode-block" id="OptimizationResult.archive"><a class="viewcode-back" href="../../api.html#prms_python.OptimizationResult.archive">[docs]</a>    <span class="k">def</span> <span class="nf">archive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remove_sims</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_meta</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">metric_freq</span><span class="o">=</span><span class="s1">&#39;daily&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create archive directory to hold json files that contain </span>
<span class="sd">            information of adjusted parameters, model output, and performance </span>
<span class="sd">            metrics for each Optimizer simulation of the </span>
<span class="sd">            OptimizationResult.stage in the OptimizationResult.working_dir.                  </span>
<span class="sd">                                                                                    </span>
<span class="sd">            Kwargs:                                                              </span>
<span class="sd">                remove_sims (bool) : If True recursively delete all folders </span>
<span class="sd">                    and files associated with original simulations of the </span>
<span class="sd">                    OptimizationResult.stage in the </span>
<span class="sd">                    OptimizationResult.working_dir, if False do not delete </span>
<span class="sd">                    simulations.</span>
<span class="sd">                remove_meta (bool) : Whether to delete original Optimizer</span>
<span class="sd">                    JSON metadata files, default is False.</span>
<span class="sd">                metric_freq (Str) : Frequency of output metric computation </span>
<span class="sd">                    for recording of model performance. Can be &#39;daily&#39; </span>
<span class="sd">                    (default) or &#39;monthly&#39;. Note, other results can be computed </span>
<span class="sd">                    later with archived results. </span>
<span class="sd">            Returns:                                                                </span>
<span class="sd">                None                          </span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="c1"># create output archive directory</span>
        <span class="n">archive_dir</span> <span class="o">=</span> <span class="n">OPJ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_archived&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">)</span>
        
        <span class="c1"># create table and use to make mapping dic    </span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_table</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">metric_freq</span><span class="p">,</span>\
                                  <span class="n">top_n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">total_sims</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">map_dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_ranked_sims</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        
        <span class="n">metadata_json_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_json_paths</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="p">]</span>
        <span class="c1"># get measured optimization variable path</span>
        <span class="n">first_json</span> <span class="o">=</span> <span class="n">metadata_json_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
 
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">first_json</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>                                                                                                                                                                 
            <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>                                                                                                                                                                
            <span class="n">measured_path</span> <span class="o">=</span> <span class="n">json_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;measured&#39;</span><span class="p">)</span>                                                                                                         
                                                     
        <span class="c1"># record info for each simulation and archive to JSONs</span>
        <span class="c1"># pandas series and numpy arrays are converted to Python lists </span>
        <span class="c1"># for JSON serialization</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">map_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dir_name&#39;</span><span class="p">)):</span>
            <span class="n">json_path</span> <span class="o">=</span> <span class="n">OPJ</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{sim}</span><span class="s1">.json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sim</span><span class="o">=</span><span class="n">sim</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">output_series</span> <span class="o">=</span> <span class="n">load_statvar</span><span class="p">(</span><span class="n">OPJ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span>\
                                              <span class="s1">&#39;outputs&#39;</span><span class="p">,</span> <span class="s1">&#39;statvar.dat&#39;</span><span class="p">))</span>\
                                              <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">statvar_name</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span> <span class="c1"># simulation directory was already removed</span>
                <span class="k">continue</span>
            
            <span class="c1"># look for resampling method info for the particular simulation</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">metadata_json_paths</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp_file</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">tmp_file</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">OPJ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">sim</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tmp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sim_dirs&#39;</span><span class="p">):</span>
                        <span class="n">resample</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resample&#39;</span><span class="p">)</span>
                        <span class="n">noise_factor</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;noise_factor&#39;</span><span class="p">)</span>   
                        <span class="n">mu_factor</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mu_factor&#39;</span><span class="p">)</span>   

            <span class="n">json_data</span> <span class="o">=</span> <span class="p">{</span>
                          <span class="s1">&#39;param_names&#39;</span> <span class="p">:</span> <span class="p">[],</span>
                          <span class="s1">&#39;param_values&#39;</span> <span class="p">:</span> <span class="p">[],</span>
                          <span class="s1">&#39;original_param_path&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_params</span><span class="p">,</span> 
                          <span class="s1">&#39;measured_path&#39;</span> <span class="p">:</span> <span class="n">measured_path</span><span class="p">,</span>
                          <span class="s1">&#39;output_name&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">statvar_name</span><span class="p">,</span>
                          <span class="s1">&#39;output_date_index&#39;</span> <span class="p">:</span> <span class="n">output_series</span><span class="o">.</span>\
                                                   <span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                          <span class="s1">&#39;output_values&#39;</span> <span class="p">:</span> <span class="n">output_series</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                          <span class="s1">&#39;metric_freq&#39;</span> <span class="p">:</span> <span class="n">metric_freq</span><span class="p">,</span>
                          <span class="s1">&#39;resample&#39;</span> <span class="p">:</span> <span class="n">resample</span><span class="p">,</span>
                          <span class="s1">&#39;stage&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="p">,</span>
                          <span class="s1">&#39;mu_factor&#39;</span> <span class="p">:</span> <span class="n">mu_factor</span><span class="p">,</span>
                          <span class="s1">&#39;noise_factor&#39;</span> <span class="p">:</span> <span class="n">noise_factor</span><span class="p">,</span>
                          <span class="s1">&#39;NSE&#39;</span> <span class="p">:</span> <span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sim</span><span class="p">,</span> <span class="s1">&#39;NSE&#39;</span><span class="p">],</span>
                          <span class="s1">&#39;RMSE&#39;</span> <span class="p">:</span> <span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sim</span><span class="p">,</span> <span class="s1">&#39;RMSE&#39;</span><span class="p">],</span>
                          <span class="s1">&#39;PBIAS&#39;</span> <span class="p">:</span> <span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sim</span><span class="p">,</span> <span class="s1">&#39;PBIAS&#39;</span><span class="p">],</span>
                          <span class="s1">&#39;COEF_DET&#39;</span> <span class="p">:</span> <span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sim</span><span class="p">,</span> <span class="s1">&#39;COEF_DET&#39;</span><span class="p">]</span>        
                        <span class="p">}</span>  
           
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">map_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;params_adjusted&#39;</span><span class="p">)[</span><span class="n">i</span><span class="p">]:</span>  
                <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;param_names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;param_values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Parameters</span><span class="p">(</span>\
                                          <span class="n">map_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;param_path&#39;</span><span class="p">)[</span><span class="n">i</span><span class="p">])[</span><span class="n">param</span><span class="p">]</span>\
                                          <span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="c1"># save JSON file into archive directory    </span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outf</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="n">outf</span><span class="p">,</span> <span class="n">sort_keys</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">indent</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>\
                          <span class="n">ensure_ascii</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>     

            <span class="c1"># recursively delete all simulation directories after archiving</span>
            <span class="k">if</span> <span class="n">remove_sims</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">OPJ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">sim</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">,</span>\
                                                                <span class="n">topdown</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="c1"># optional delete the original JSON metadata</span>
        <span class="k">if</span> <span class="n">remove_meta</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">meta_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_json_paths</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stage</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">meta_file</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">continue</span></div></div>
    

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/prms-python-200x.png" alt="Logo"/>
    
  </a>
</p>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=PRMS-Python&repo=docs&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial and Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html#example-parameter-sensitivity">Example: Parameter sensitivity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">Command-Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html#indices-and-tables">Indices and tables</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, John Volk and Matthew Turner.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
  </body>
</html>